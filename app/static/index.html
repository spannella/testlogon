<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Security Control Panel</title>
  <script src="https://js.stripe.com/v3/"></script>
  <link rel="stylesheet" href="/static/styles.css" />
  <link rel="preload" href="https://js.ccbill.com/v1.12.2/ccbill-advanced-widget.js" as="script" />
  <script src="https://js.ccbill.com/v1.12.2/ccbill-advanced-widget.js"></script>
</head>
<body>

<div class="topbar">
  <div>
    <div><b>Control Panel</b></div>
    <div class="muted" id="whoami">Not logged in</div>
  </div>
  <div class="toolbar">
    <button id="btnRefreshAll">Refresh</button>
    <button onclick="document.getElementById('billingSection').scrollIntoView({behavior:'smooth'});">Billing</button>
    <button id="btnSetTokens">Set tokens</button>
    <button id="btnClearSession">Logout UI session</button>
    <button id="btnClearTokens">Clear tokens</button>
  </div>
</div>

<div class="row" id="ccbillSection">
  <div class="card">
    <h3>API Key IP Allowlist</h3>
    <div class="muted">CIDR or IP. If empty → all IPs allowed.</div>
    <div class="muted">Selected key: <code class="mono" id="allowKeyId">none</code></div>
    <div class="row-inline" style="margin-top:8px;">
      <input id="allowAddVal" placeholder="1.2.3.4 or 1.2.3.0/24" style="margin-top:0; flex:1;" />
      <button id="allowAddBtn">Add</button>
    </div>
    <table id="allowTbl">
      <thead><tr><th>IP/CIDR</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h3>API Keys</h3>
    <div class="muted">Manage API keys and IP rules.</div>
    <div class="row-inline" style="margin-top:10px;">
      <button id="keysRefreshBtn">Refresh</button>
      <button id="keysCreateBtn">Create key</button>
    </div>
    <div id="keysList" class="list"></div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>Account Permanent Closure</h3>
    <div class="muted">Permanently closes your account and removes all stored data for this user.</div>
    <div class="row-inline" style="margin-top:10px;">
      <button class="danger" id="accountCloseBtn">Permanently close account</button>
    </div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>TOTP Devices</h3>
    <div class="row-inline" style="margin-top:10px;">
      <button id="totpAddBtn">Add device</button>
      <button id="totpRefreshBtn">Refresh</button>
    </div>
    <div class="muted">Any one device can satisfy TOTP factor. Adding/removing requires a TOTP code.</div>
    <table id="totpTbl">
      <thead><tr><th>Label</th><th>Enabled</th><th>Last Used</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h3>SMS Devices</h3>
    <div class="muted">Up to 3 phone numbers. Login SMS codes are sent to all enabled numbers.</div>
    <div class="row-inline" style="margin-top:10px;">
      <button id="smsRefreshBtn">Refresh</button>
      <button id="smsAddBtn">Add phone</button>
    </div>
    <table id="smsTbl">
      <thead><tr><th>Phone</th><th>Label</th><th>Enabled</th><th>Last Used</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>Email Devices</h3>
    <div class="muted">Up to 5 emails. Login email codes are sent to all enabled emails.</div>
    <div class="row-inline" style="margin-top:10px;">
      <button id="emailRefreshBtn">Refresh</button>
      <button id="emailAddBtn">Add email</button>
    </div>
    <table id="emailTbl">
      <thead><tr><th>Email</th><th>Label</th><th>Enabled</th><th>Last Used</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h3>Web UI Sessions</h3>
    <div class="muted">Your active UI sessions (this browser will show as “current”).</div>
    <div class="row-inline" style="margin-top:10px;">
      <button id="sessRefreshBtn">Refresh</button>
      <button id="sessRevokeOthersBtn">Revoke all other sessions</button>
    </div>
    <div id="sessList" class="list"></div>
  </div>

  <div class="card">
    <h3>Account Suspension & Reactivation</h3>
    <div class="muted">Start a suspension or reactivation request for this account.</div>
    <div class="section">
      <div><span id="accountStatusPill" class="pill">Unknown</span></div>
      <div id="accountStatusMeta" class="muted" style="margin-top:6px;"></div>
      <div id="accountStatusReason" class="muted"></div>
    </div>
    <div class="row-inline" style="margin-top:10px;">
      <button id="accountSuspendBtn" class="danger">Start suspension</button>
      <button id="accountReactivateBtn">Start reactivation</button>
    </div>
    <div id="accountStatusMsg" class="muted" style="margin-top:8px;"></div>
  </div>
</div>

<div class="row">
  <div class="card" style="width:100%">
    <h3>Password Recovery (Cognito)</h3>
    <div class="muted">Reset your password and complete every enabled MFA challenge before confirming.</div>
    <div class="row-inline" style="margin-top:10px;">
      <input id="pwRecoveryUsername" placeholder="Username or email" style="flex:1;" />
      <button id="pwRecoveryStartBtn">Start recovery</button>
    </div>
    <div id="pwRecoveryDelivery" class="muted" style="margin-top:8px;"></div>
    <div id="pwRecoveryChallenge" class="muted" style="margin-top:6px;"></div>
    <div id="pwRecoveryChallenges" class="section"></div>
    <div class="row-inline" style="margin-top:10px;">
      <input id="pwRecoveryCode" placeholder="Confirmation code" />
      <input id="pwRecoveryNewPassword" placeholder="New password" type="password" />
      <button id="pwRecoveryConfirmBtn">Confirm new password</button>
    </div>
    <div id="pwRecoveryMsg" class="muted" style="margin-top:8px;"></div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>User Profile</h3>
    <div class="muted">Manage profile details displayed to other users.</div>
    <div class="row-inline" style="margin-top:10px;">
      <button id="profileLoadBtn">Load</button>
      <button id="profileSavePatchBtn">Save (Patch)</button>
      <button id="profileSaveReplaceBtn" class="primary">Save (Replace)</button>
      <button id="profileResetBtn">Reset</button>
      <span id="profileStatus" class="muted"></span>
    </div>
    <div class="section">
      <div class="grid">
        <div>
          <label class="muted">Display name</label>
          <input id="profileDisplayName" type="text" />
        </div>
        <div>
          <label class="muted">Title</label>
          <input id="profileTitle" type="text" />
        </div>
        <div>
          <label class="muted">First name</label>
          <input id="profileFirstName" type="text" />
        </div>
        <div>
          <label class="muted">Middle name</label>
          <input id="profileMiddleName" type="text" />
        </div>
        <div>
          <label class="muted">Last name</label>
          <input id="profileLastName" type="text" />
        </div>
        <div>
          <label class="muted">Birthday</label>
          <input id="profileBirthday" type="date" />
        </div>
        <div>
          <label class="muted">Gender</label>
          <select id="profileGender">
            <option value="">(unset)</option>
            <option value="male">male</option>
            <option value="female">female</option>
            <option value="non_binary">non_binary</option>
            <option value="other">other</option>
            <option value="prefer_not_to_say">prefer_not_to_say</option>
          </select>
        </div>
        <div>
          <label class="muted">Location</label>
          <input id="profileLocation" type="text" />
        </div>
        <div>
          <label class="muted">Displayed email</label>
          <input id="profileEmail" type="email" />
        </div>
        <div>
          <label class="muted">Displayed phone</label>
          <input id="profilePhone" type="text" />
        </div>
      </div>
    </div>
    <div class="section">
      <label class="muted">Description</label>
      <textarea id="profileDescription" rows="3"></textarea>
    </div>
    <div class="section">
      <b>Mailing address</b>
      <div class="grid" style="margin-top:8px;">
        <div>
          <label class="muted">Line 1</label>
          <input id="profileAddrLine1" type="text" />
        </div>
        <div>
          <label class="muted">Line 2</label>
          <input id="profileAddrLine2" type="text" />
        </div>
        <div>
          <label class="muted">City</label>
          <input id="profileAddrCity" type="text" />
        </div>
        <div>
          <label class="muted">State</label>
          <input id="profileAddrState" type="text" />
        </div>
        <div>
          <label class="muted">Postal code</label>
          <input id="profileAddrPostal" type="text" />
        </div>
        <div>
          <label class="muted">Country (ISO-2)</label>
          <input id="profileAddrCountry" type="text" />
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Profile Media + Languages</h3>
    <div class="section">
      <b>Languages</b>
      <div class="row-inline" style="margin-top:8px;">
        <input id="profileLangName" placeholder="Language" />
        <select id="profileLangLevel">
          <option value="native">native</option>
          <option value="fluent">fluent</option>
          <option value="advanced">advanced</option>
          <option value="intermediate">intermediate</option>
          <option value="basic">basic</option>
          <option value="A1">A1</option>
          <option value="A2">A2</option>
          <option value="B1">B1</option>
          <option value="B2">B2</option>
          <option value="C1">C1</option>
          <option value="C2">C2</option>
        </select>
        <button id="profileLangAddBtn">Add / Update</button>
      </div>
      <div id="profileLangList" class="list"></div>
    </div>
    <div class="section">
      <b>Profile photo</b>
      <div class="row-inline" style="margin-top:8px;">
        <input id="profilePhotoFile" type="file" accept="image/*" />
        <button id="profilePhotoUploadBtn">Upload</button>
      </div>
      <div class="muted mono break" id="profilePhotoUrl"></div>
      <img id="profilePhotoPreview" class="hidden" alt="Profile photo preview" style="margin-top:8px; max-width:100%; border-radius:10px; border:1px solid #eee;" />
    </div>
    <div class="section">
      <b>Cover photo</b>
      <div class="row-inline" style="margin-top:8px;">
        <input id="profileCoverFile" type="file" accept="image/*" />
        <button id="profileCoverUploadBtn">Upload</button>
      </div>
      <div class="muted mono break" id="profileCoverUrl"></div>
      <img id="profileCoverPreview" class="hidden" alt="Cover photo preview" style="margin-top:8px; max-width:100%; border-radius:10px; border:1px solid #eee;" />
    </div>
    <div class="section">
      <div class="row-inline">
        <button id="profileAuditRefreshBtn">Refresh Audit</button>
        <span id="profileAuditStatus" class="muted"></span>
      </div>
      <div id="profileAuditList" class="list"></div>
    </div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>Alert Recipients</h3>
    <div class="section">
      <b>Email recipients</b>
      <div class="row-inline" style="margin-top:8px;">
        <input id="alertEmailInput" placeholder="security@example.com" />
        <button id="alertEmailAddBtn">Add</button>
      </div>
      <div id="alertEmailList" class="list"></div>
    </div>
    <div class="section">
      <b>SMS recipients</b>
      <div class="row-inline" style="margin-top:8px;">
        <input id="alertSmsInput" placeholder="+15551234567 or 5551234567" />
        <button id="alertSmsAddBtn">Add</button>
      </div>
      <div id="alertSmsList" class="list"></div>
    </div>
  </div>

  <div class="card">
    <h3>Alert Preferences</h3>
    <div class="section">
      <b>Email alert types</b>
      <div class="muted">Checked types will send email when those events occur.</div>
      <div id="alertTypeChecklist" class="list" style="margin-top:8px;"></div>
      <div class="row-inline" style="margin-top:10px;">
        <button id="alertTypesSaveBtn">Save</button>
      </div>
      <div id="alertTypesMsg" class="muted"></div>
    </div>
    <div class="section">
      <b>SMS alert types</b>
      <div class="muted">Checked types will send SMS when those events occur.</div>
      <div id="alertSmsTypeChecklist" class="list" style="margin-top:8px;"></div>
      <div class="row-inline" style="margin-top:10px;">
        <button id="alertSmsTypesSaveBtn">Save</button>
      </div>
      <div id="alertSmsTypesMsg" class="muted"></div>
    </div>
    <div class="section">
      <b>Toast alert types</b>
      <div class="muted">Checked types will show a toast notification on all active web sessions.</div>
      <div id="alertToastTypeChecklist" class="list" style="margin-top:8px;"></div>
      <div class="row-inline" style="margin-top:10px;">
        <button id="alertToastTypesSaveBtn">Save</button>
      </div>
      <div id="alertToastTypesMsg" class="muted"></div>
    </div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>Push Notifications</h3>
    <div class="muted">Register this browser for push alerts.</div>
    <div class="row-inline" style="margin-top:10px;">
      <button id="btnEnablePush">Enable push on this browser</button>
      <button id="btnPushTest">Send test push</button>
    </div>
    <div id="pushMsg" class="muted"></div>
    <div class="section">
      <b>Push alert types</b>
      <div id="alertPushTypeChecklist" class="list" style="margin-top:8px;"></div>
      <div class="row-inline" style="margin-top:10px;">
        <button id="alertPushTypesSaveBtn">Save</button>
      </div>
      <div id="alertPushTypesMsg" class="muted"></div>
    </div>
    <div class="section">
      <b>Registered push devices</b>
      <div id="pushDevicesList" class="list"></div>
    </div>
  </div>

  <div class="card">
    <h3>Recent Alerts</h3>
    <div class="muted">Latest alerts for this account.</div>
    <div id="alertsList" class="list"></div>
  </div>
</div>

<div id="billingSection" class="row">
  <div class="card" style="width:100%">
    <h3>Billing</h3>
    <div class="muted">Manage CCBill, PayPal, and Stripe payment flows from one place.</div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>Billing (CCBill)</h3>
    <div class="muted">
      Use the CCBill widget to create a <code>paymentTokenId</code>, save it, then charge or subscribe using the billing API.
    </div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>CCBill Status</h3>
    <div class="row-inline" style="margin-top:10px;">
      <button id="ccbillRefreshBtn">Refresh billing</button>
    </div>
    <div class="list" style="margin-top:10px;">
      <div><span class="pill">Settings</span> <span id="ccbillSettingsOut" class="mono"></span></div>
      <div><span class="pill">Balance</span> <span id="ccbillBalanceOut" class="mono"></span></div>
    </div>
  </div>

  <div class="card">
    <h3>Add Card (Create Payment Token)</h3>
    <div class="muted">Creates a token via <code>createPaymentToken()</code> and saves it to the backend.</div>
    <div id="ccbillConfigBox" class="muted mono" style="margin-top:8px;"></div>

    <form id="ccbillPaymentForm">
      <div class="row-inline">
        <input data-ccbill="customerName" placeholder="Cardholder name" autocomplete="cc-name" required />
        <input data-ccbill="email" placeholder="email@example.com" autocomplete="email" required />
      </div>

      <div class="row-inline">
        <input data-ccbill="cardNumber" placeholder="4111111111111111" autocomplete="cc-number" required />
        <input data-ccbill="expMonth" placeholder="12" autocomplete="cc-exp-month" required />
        <input data-ccbill="expYear" placeholder="2030" autocomplete="cc-exp-year" required />
        <input data-ccbill="cvv" placeholder="123" autocomplete="cc-csc" required />
      </div>

      <div class="row-inline">
        <input data-ccbill="address1" placeholder="123 Main St" autocomplete="address-line1" />
        <input data-ccbill="city" placeholder="City" autocomplete="address-level2" />
        <input data-ccbill="state" placeholder="State" autocomplete="address-level1" />
        <input data-ccbill="postalCode" placeholder="Postal Code" autocomplete="postal-code" />
        <input data-ccbill="country" placeholder="US" autocomplete="country" />
      </div>

      <div class="row-inline" style="margin-top:8px;">
        <button id="ccbillCreateTokenBtn" type="button">Create token</button>
        <label class="muted" style="margin:0; display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="ccbillMakeDefault" checked />
          Make default
        </label>
      </div>
    </form>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>Payment Methods</h3>
    <div class="row-inline" style="margin-top:10px;">
      <button id="ccbillRefreshMethodsBtn">Refresh methods</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Token</th>
          <th>Label</th>
          <th>Priority</th>
          <th class="right">Actions</th>
        </tr>
      </thead>
      <tbody id="ccbillPmTbody"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>Subscriptions & Charges</h3>
    <label>Monthly price (cents)</label>
    <input id="ccbillMonthlyCents" value="999" />
    <label>Plan ID</label>
    <input id="ccbillPlanId" value="monthly" />
    <div class="row-inline" style="margin-top:8px;">
      <button id="ccbillSubscribeBtn">Start subscription</button>
    </div>

    <label style="margin-top:12px;">One-time amount (cents)</label>
    <input id="ccbillOneTimeCents" value="500" />
    <div class="row-inline" style="margin-top:8px;">
      <button id="ccbillChargeOnceBtn">Charge once</button>
      <button id="ccbillPayBalanceBtn">Pay settled balance</button>
    </div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>CCBill Debug</h3>
    <div class="row-inline" style="margin-top:10px;">
      <button id="ccbillLoadSubscriptionsBtn">Subscriptions</button>
      <button id="ccbillLoadPaymentsBtn">Payments</button>
      <button id="ccbillLoadLedgerBtn">Ledger</button>
    </div>
    <textarea id="ccbillDebugOut" class="mono" readonly></textarea>
  </div>

  <div class="card">
    <h3>CCBill Log</h3>
    <textarea id="ccbillLog" class="mono" readonly></textarea>
  </div>
</div>

<div class="row">
  <div class="card" style="margin-top:16px; width:100%;">
    <h3>Billing (PayPal)</h3>
    <div class="muted">
      Assumes login is handled. This UI sends <code>X-User-Id</code> on each request.
    </div>
    <div class="row-inline" style="margin-top:10px;">
      <label class="muted">User ID</label>
      <input id="paypal_uid" placeholder="u_123" style="width:280px; margin-top:0;"/>
      <button class="primary" onclick="paypalRefreshAll()">Refresh</button>
      <span id="paypal_status" class="muted"></span>
    </div>
    <div class="row-inline muted">
      <div>Tip:</div>
      <div>When PayPal redirects back here, we can auto-capture an approved order if <code>?token=ORDER_ID</code> is present.</div>
    </div>
  </div>
</div>

<div class="grid" style="margin-top:16px;">
  <div class="row">
    <div class="card">
      <h3 style="margin:0 0 8px 0">Balance</h3>
      <div class="row">
        <div>
          <div class="muted">Due (settled)</div>
          <div class="mono" style="font-size:22px" id="paypal_due_settled">—</div>
        </div>
        <div style="width:24px"></div>
        <div>
          <div class="muted">Due (if pending settles)</div>
          <div class="mono" style="font-size:22px" id="paypal_due_all">—</div>
        </div>
      </div>

      <div class="section">
        <div class="row">
          <div class="muted">Owed pending:</div><div class="mono" id="paypal_owed_pending">—</div>
          <div class="muted">Owed settled:</div><div class="mono" id="paypal_owed_settled">—</div>
        </div>
        <div class="row">
          <div class="muted">Payments pending:</div><div class="mono" id="paypal_pay_pending">—</div>
          <div class="muted">Payments settled:</div><div class="mono" id="paypal_pay_settled">—</div>
        </div>
      </div>

      <div class="section">
        <div class="row">
          <button class="primary" onclick="paypalPaySettledBalance()">Pay settled balance</button>
          <input id="paypal_pay_amount" placeholder="amount (optional, cents)" style="width:220px; margin-top:0;"/>
          <span id="paypal_pay_result" class="muted"></span>
        </div>
      </div>

      <div class="section">
        <div class="row">
          <label class="muted">Autopay</label>
          <input type="checkbox" id="paypal_autopay" onchange="paypalSetAutopay()"/>
          <span class="muted">Autopay scheduling is backend/worker responsibility (webhook settles).</span>
        </div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 8px 0">One-time charge</h3>
        <div class="muted">Creates a PayPal order; if approval is required, you’ll be redirected to PayPal and back.</div>
        <div class="row" style="margin-top:10px">
          <input id="paypal_charge_amount" placeholder="amount (cents)" style="width:220px; margin-top:0;"/>
          <select id="paypal_charge_use_default">
            <option value="1" selected>Use default saved method</option>
            <option value="0">Pick token manually</option>
          </select>
          <input id="paypal_charge_token" placeholder="payment_token_id (optional)" style="width:360px; margin-top:0;" class="hidden"/>
        </div>
        <div class="row">
          <button class="primary" onclick="paypalChargeOnce()">Create order</button>
          <button onclick="paypalCaptureFromUrlToken()">Capture ?token (if present)</button>
          <span id="paypal_charge_result" class="muted"></span>
        </div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 8px 0">Monthly subscription</h3>
        <div class="muted">Creates a PayPal subscription (approval required). Activate/renewal handled via webhooks.</div>
        <div class="row" style="margin-top:10px">
          <input id="paypal_sub_plan" placeholder="plan_id (your internal, e.g. monthly)" style="width:320px; margin-top:0;" value="monthly"/>
          <input id="paypal_sub_paypal_plan" placeholder="paypal_plan_id (optional override)" style="width:360px; margin-top:0;"/>
        </div>
        <div class="row">
          <button class="primary" onclick="paypalStartSubscription()">Start subscription</button>
          <span id="paypal_sub_result" class="muted"></span>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Payment methods (PayPal Vault)</h3>

      <div class="row">
        <button onclick="showPaypalPane('add_paypal')">Add PayPal</button>
        <button onclick="showPaypalPane('add_card')">Add Card</button>
        <button onclick="showPaypalPane('list_methods')" class="primary">List</button>
      </div>

      <div class="section">
        <div id="paypal_pane_add_paypal" class="paypal-pane">
          <div class="muted">
            1) Create a setup token → 2) Approve on PayPal → 3) Exchange setup token for a saved <code>payment_token_id</code>.
          </div>
          <div class="row" style="margin-top:10px">
            <input id="paypal_pm_label_paypal" placeholder="label (optional)" style="width:260px; margin-top:0;"/>
            <label class="muted"><input type="checkbox" id="paypal_pm_default_paypal" checked/> make default</label>
            <button class="primary" onclick="paypalCreateSetupToken('paypal')">Create + Open approval</button>
          </div>
          <div class="row">
            <div class="muted">Last setup token:</div>
            <div class="mono"><code id="paypal_last_setup_token">—</code></div>
            <a id="paypal_last_approve_link" class="btnlink primary hidden" target="_blank" rel="noreferrer">Open approval</a>
          </div>
          <div class="row">
            <button class="primary" onclick="paypalExchangeLastSetupToken()">Finalize save (exchange)</button>
            <span id="paypal_add_paypal_result" class="muted"></span>
          </div>
          <div class="muted">
            If PayPal redirects you back here, just click “Finalize save (exchange)”.
          </div>
        </div>

        <div id="paypal_pane_add_card" class="paypal-pane hidden">
          <div class="muted">
            Card vaulting via PayPal Vault. (Depending on your account setup, you may use PayPal JS SDK for card entry.)
          </div>
          <div class="row" style="margin-top:10px">
            <input id="paypal_pm_label_card" placeholder="label (optional)" style="width:260px; margin-top:0;"/>
            <label class="muted"><input type="checkbox" id="paypal_pm_default_card" checked/> make default</label>
            <button class="primary" onclick="paypalCreateSetupToken('card')">Create + Open approval</button>
          </div>
          <div class="row">
            <div class="muted">Last setup token:</div>
            <div class="mono"><code id="paypal_last_setup_token_card">—</code></div>
            <a id="paypal_last_approve_link_card" class="btnlink primary hidden" target="_blank" rel="noreferrer">Open approval</a>
          </div>
          <div class="row">
            <button class="primary" onclick="paypalExchangeLastSetupToken('card')">Finalize save (exchange)</button>
            <span id="paypal_add_card_result" class="muted"></span>
          </div>
        </div>

        <div id="paypal_pane_list_methods" class="paypal-pane hidden">
          <div class="row">
            <label class="muted"><input type="checkbox" id="paypal_del_from_paypal"/> delete from PayPal too</label>
            <span class="muted">(otherwise only removes from your DB)</span>
          </div>
          <div id="paypal_methods" class="list"></div>
        </div>
      </div>
    </div>
</div>
</div>

<div class="row">
  <div class="card">
    <h3 style="margin:0 0 8px 0">PayPal Ledger</h3>
    <div class="row">
      <button onclick="paypalLoadLedger()">Refresh ledger</button>
      <input id="paypal_ledger_limit" placeholder="limit (default 50)" style="width:200px"/>
      <span class="muted">Shows most recent first</span>
    </div>
    <div id="paypal_ledger" class="list" style="margin-top:10px"></div>
  </div>
</div>

<div class="row">
  <div class="card" style="margin-top:16px; width:100%;">
    <h3>Billing (Stripe)</h3>
    <div class="muted">Manage payment methods, balances, and ledger entries.</div>
    <div class="row-inline" style="margin-top:10px;">
      <button id="stripeRefreshBtn">Refresh billing</button>
      <span id="stripeStatus" class="muted"></span>
    </div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3 style="margin:0 0 8px 0">Balance</h3>
    <div class="row">
      <div>
        <div class="muted">Due (settled)</div>
        <div class="mono" style="font-size:22px" id="stripe_due_settled">—</div>
      </div>
      <div style="width:24px"></div>
      <div>
        <div class="muted">Due (if pending settles)</div>
        <div class="mono" style="font-size:22px" id="stripe_due_all">—</div>
      </div>
    </div>

    <div class="section">
      <div class="row">
        <div class="muted">Owed pending:</div><div class="mono" id="stripe_owed_pending">—</div>
        <div class="muted">Owed settled:</div><div class="mono" id="stripe_owed_settled">—</div>
      </div>
      <div class="row">
        <div class="muted">Payments pending:</div><div class="mono" id="stripe_pay_pending">—</div>
        <div class="muted">Payments settled:</div><div class="mono" id="stripe_pay_settled">—</div>
      </div>
    </div>

    <div class="section">
      <div class="row">
        <button class="primary" id="stripePaySettledBalanceBtn">Pay settled balance</button>
        <input id="stripe_pay_amount" placeholder="amount (optional, cents)" style="width:220px"/>
        <span id="stripe_pay_result" class="muted"></span>
      </div>

      <div class="row">
        <label class="muted">Autopay</label>
        <input type="checkbox" id="stripe_autopay"/>
        <span class="muted">Webhook-driven settlement; autopay scheduling is backend/worker responsibility.</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0">Payment methods</h3>

    <div class="row">
      <button id="stripePaneAddCardBtn">Add card</button>
      <button id="stripePaneAddBankBtn">Add checking (ACH)</button>
      <button id="stripePaneVerifyBankBtn">Verify microdeposits</button>
      <button id="stripePaneListMethodsBtn" class="primary">List</button>
    </div>

    <div class="hr"></div>

    <div id="stripe_pane_add_card" class="stripe-pane">
      <div class="muted">Add a credit/debit card (saved for future off-session payments).</div>
      <div style="margin-top:10px" id="stripe_card_element"></div>
      <div class="row" style="margin-top:10px">
        <button class="primary" id="stripeAddCardBtn">Save card</button>
        <span id="stripe_add_card_result" class="muted"></span>
      </div>
    </div>

    <div id="stripe_pane_add_bank" class="stripe-pane hidden">
      <div class="muted">
        Add a US checking account via ACH. Microdeposit verification may be required.
      </div>
      <div class="row" style="margin-top:10px">
        <input id="stripe_bank_name" placeholder="Name (for mandate)" style="width:260px"/>
        <input id="stripe_bank_email" placeholder="Email (optional)" style="width:260px"/>
      </div>
      <div class="row">
        <button class="primary" id="stripeAddBankAccountBtn">Start ACH setup</button>
        <span id="stripe_add_bank_result" class="muted"></span>
      </div>
      <div id="stripe_bank_next" class="muted" style="margin-top:10px"></div>
    </div>

    <div id="stripe_pane_verify_bank" class="stripe-pane hidden">
      <div class="muted">
        If the SetupIntent requires microdeposit verification, paste the SetupIntent ID below and verify by amounts or descriptor code.
      </div>

      <div class="row" style="margin-top:10px">
        <input id="stripe_verify_si" placeholder="setup_intent_id (e.g. seti_...)" style="width:420px"/>
        <button id="stripeUsePendingSetupIntentBtn">Use last pending from this browser</button>
      </div>

      <div class="row">
        <input id="stripe_amt1" placeholder="amount1 (cents)" style="width:180px"/>
        <input id="stripe_amt2" placeholder="amount2 (cents)" style="width:180px"/>
        <button class="primary" id="stripeVerifyByAmountsBtn">Verify by amounts</button>
      </div>

      <div class="row">
        <input id="stripe_desc" placeholder="descriptor code (optional)" style="width:300px"/>
        <button class="primary" id="stripeVerifyByDescriptorBtn">Verify by code</button>
      </div>

      <div class="row">
        <span id="stripe_verify_result" class="muted"></span>
      </div>
    </div>

    <div id="stripe_pane_list_methods" class="stripe-pane hidden">
      <div id="stripe_methods" class="list"></div>
    </div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3 style="margin:0 0 8px 0">Ledger</h3>
    <div class="row">
      <button id="stripeLoadLedgerBtn">Refresh ledger</button>
      <input id="stripe_ledger_limit" placeholder="limit (default 50)" style="width:200px"/>
      <span class="muted">Shows most recent first</span>
    </div>
    <div id="stripe_ledger" class="list" style="margin-top:10px"></div>
  </div>
</div>
<div class="err" id="globalErr" style="margin-top:12px;"></div>

<div id="toastContainer" class="toast-container"></div>

<script src="/static/main.js"></script>
<script>
let paypalLastSetupTokenPaypal = null;
let paypalLastSetupTokenCard = null;

function paypalFmtMoney(cents, currency='usd') {
  const sign = cents < 0 ? "-" : "";
  const v = Math.abs(cents) / 100.0;
  return sign + v.toFixed(2) + " " + currency.toUpperCase();
}

function paypalSetStatus(msg) {
  document.getElementById('paypal_status').innerText = msg || '';
}

async function paypalApi(path, opts={}) {
  const uid = document.getElementById('paypal_uid').value.trim();
  if (!uid) throw new Error("Set User ID first");
  opts.headers = Object.assign({}, opts.headers||{}, {'X-User-Id': uid, 'Content-Type': 'application/json'});
  const r = await fetch(path, opts);
  const txt = await r.text();
  if (!r.ok) throw new Error(txt || r.statusText);
  return txt ? JSON.parse(txt) : null;
}

function showPaypalPane(which) {
  const panes = ['add_paypal','add_card','list_methods'];
  for (const p of panes) document.getElementById('paypal_pane_' + p).classList.add('hidden');
  document.getElementById('paypal_pane_' + which).classList.remove('hidden');
}

function paypalPillForType(t) {
  const x = (t || '').toLowerCase();
  if (x === 'paypal') return '<span class="pill ok">PAYPAL</span>';
  if (x === 'card') return '<span class="pill warn">CARD</span>';
  if (x) return '<span class="pill">' + x.toUpperCase() + '</span>';
  return '<span class="pill">TOKEN</span>';
}

async function paypalRefreshAll() {
  try {
    paypalSetStatus("Loading...");

    const bal = await paypalApi('/api/billing/balance');
    document.getElementById('paypal_due_settled').innerText = paypalFmtMoney(bal.due_settled_cents, bal.currency);
    document.getElementById('paypal_due_all').innerText = paypalFmtMoney(bal.due_if_all_settles_cents, bal.currency);

    document.getElementById('paypal_owed_pending').innerText = paypalFmtMoney(bal.owed_pending_cents, bal.currency);
    document.getElementById('paypal_owed_settled').innerText = paypalFmtMoney(bal.owed_settled_cents, bal.currency);
    document.getElementById('paypal_pay_pending').innerText = paypalFmtMoney(bal.payments_pending_cents, bal.currency);
    document.getElementById('paypal_pay_settled').innerText = paypalFmtMoney(bal.payments_settled_cents, bal.currency);

    const settings = await paypalApi('/api/billing/settings');
    document.getElementById('paypal_autopay').checked = !!settings.autopay_enabled;

    await paypalLoadPaymentMethods();
    await paypalLoadLedger();

    await paypalCaptureFromUrlToken(true);

    document.getElementById('paypal_charge_use_default').onchange = () => {
      const useDefault = document.getElementById('paypal_charge_use_default').value === '1';
      document.getElementById('paypal_charge_token').classList.toggle('hidden', useDefault);
    };

    showPaypalPane('list_methods');
    paypalSetStatus("OK");
  } catch (e) {
    paypalSetStatus("Error: " + e.message);
  }
}

async function paypalLoadPaymentMethods() {
  const methods = await paypalApi('/api/billing/payment-methods');
  paypalRenderMethods(methods);
}

function paypalRenderMethods(methods) {
  const wrap = document.getElementById('paypal_methods');
  wrap.innerHTML = '';
  methods.sort((a,b)=>a.priority-b.priority);

  for (const m of methods) {
    const div = document.createElement('div');
    div.className = 'item';

    const label = m.label || '';
    div.innerHTML = `
      <div class="row">
        ${paypalPillForType(m.pm_type)}
        <div class="mono"><code>${m.payment_token_id}</code></div>
        <div>${label}</div>
        <div class="right muted">priority</div>
        <input value="${m.priority}" style="width:90px; margin-top:0;" onchange="paypalSetPriority('${m.payment_token_id}', this.value)"/>
      </div>
      <div class="row">
        <button class="primary" onclick="paypalSetDefault('${m.payment_token_id}')">Set default</button>
        <button class="danger" onclick="paypalRemovePM('${m.payment_token_id}')">Remove</button>
        <span class="muted" id="paypal_pm_msg_${m.payment_token_id}"></span>
      </div>
    `;
    wrap.appendChild(div);
  }

  if (methods.length === 0) {
    wrap.innerHTML = '<div class="muted">No payment methods yet.</div>';
  }
}

async function paypalSetPriority(tokenId, prio) {
  try {
    await paypalApi('/api/billing/payment-methods/priority', {method:'POST', body: JSON.stringify({payment_token_id: tokenId, priority: parseInt(prio)})});
    document.getElementById('paypal_pm_msg_' + tokenId).innerText = 'Saved';
  } catch (e) {
    document.getElementById('paypal_pm_msg_' + tokenId).innerText = 'Error: ' + e.message;
  }
}

async function paypalSetDefault(tokenId) {
  try {
    await paypalApi('/api/billing/payment-methods/default', {method:'POST', body: JSON.stringify({payment_token_id: tokenId})});
    document.getElementById('paypal_pm_msg_' + tokenId).innerText = 'Default set';
  } catch (e) {
    document.getElementById('paypal_pm_msg_' + tokenId).innerText = 'Error: ' + e.message;
  }
}

async function paypalRemovePM(tokenId) {
  try {
    const delFromPayPal = document.getElementById('paypal_del_from_paypal').checked;
    const qs = delFromPayPal ? '?delete_from_paypal=true' : '';
    await paypalApi('/api/billing/payment-methods/' + encodeURIComponent(tokenId) + qs, {method:'DELETE'});
    await paypalLoadPaymentMethods();
  } catch (e) {
    alert('Remove failed: ' + e.message);
  }
}

async function paypalSetAutopay() {
  try {
    const enabled = document.getElementById('paypal_autopay').checked;
    await paypalApi('/api/billing/autopay', {method:'POST', body: JSON.stringify({enabled})});
  } catch (e) {
    alert('Autopay update failed: ' + e.message);
  }
}

async function paypalPaySettledBalance() {
  document.getElementById('paypal_pay_result').innerText = '';
  try {
    const amtTxt = document.getElementById('paypal_pay_amount').value.trim();
    const payload = {};
    if (amtTxt) payload.amount_cents = parseInt(amtTxt);

    const res = await paypalApi('/api/billing/pay-balance', {method:'POST', body: JSON.stringify(payload)});
    const orderId = res.order_id || res.transaction_id || '';
    document.getElementById('paypal_pay_result').innerHTML =
      'Created order ' + (orderId ? ('<code>' + orderId + '</code>') : '') +
      (res.approve_url ? (' — <a href="' + res.approve_url + '" target="_blank" rel="noreferrer">approve</a>') : '');
    if (res.approve_url) window.open(res.approve_url, '_blank');
    setTimeout(paypalRefreshAll, 800);
  } catch (e) {
    document.getElementById('paypal_pay_result').innerText = 'Error: ' + e.message;
  }
}

async function paypalCreateSetupToken(kind) {
  if (kind === 'paypal') document.getElementById('paypal_add_paypal_result').innerText = '';
  else document.getElementById('paypal_add_card_result').innerText = '';

  try {
    const label = (kind === 'paypal')
      ? document.getElementById('paypal_pm_label_paypal').value.trim()
      : document.getElementById('paypal_pm_label_card').value.trim();

    const make_default = (kind === 'paypal')
      ? document.getElementById('paypal_pm_default_paypal').checked
      : document.getElementById('paypal_pm_default_card').checked;

    const resp = await paypalApi('/api/billing/payment-methods/paypal/setup-token', {
      method:'POST',
      body: JSON.stringify({pm_kind: kind, label, make_default})
    });

    const setupToken = resp.setup_token;
    const approveUrl = resp.approve_url;

    if (kind === 'paypal') {
      paypalLastSetupTokenPaypal = setupToken;
      localStorage.setItem('pp_last_setup_token_paypal', setupToken || '');
      document.getElementById('paypal_last_setup_token').innerText = setupToken || '—';
      const a = document.getElementById('paypal_last_approve_link');
      if (approveUrl) { a.href = approveUrl; a.classList.remove('hidden'); } else { a.classList.add('hidden'); }
      if (approveUrl) window.open(approveUrl, '_blank');
      document.getElementById('paypal_add_paypal_result').innerText = 'Setup token created. Approve in PayPal, then click Finalize.';
    } else {
      paypalLastSetupTokenCard = setupToken;
      localStorage.setItem('pp_last_setup_token_card', setupToken || '');
      document.getElementById('paypal_last_setup_token_card').innerText = setupToken || '—';
      const a = document.getElementById('paypal_last_approve_link_card');
      if (approveUrl) { a.href = approveUrl; a.classList.remove('hidden'); } else { a.classList.add('hidden'); }
      if (approveUrl) window.open(approveUrl, '_blank');
      document.getElementById('paypal_add_card_result').innerText = 'Setup token created. Approve/complete, then click Finalize.';
    }
  } catch (e) {
    if (kind === 'paypal') document.getElementById('paypal_add_paypal_result').innerText = 'Error: ' + e.message;
    else document.getElementById('paypal_add_card_result').innerText = 'Error: ' + e.message;
  }
}

async function paypalExchangeLastSetupToken(kind='paypal') {
  const msgId = (kind === 'paypal') ? 'paypal_add_paypal_result' : 'paypal_add_card_result';
  document.getElementById(msgId).innerText = '';

  try {
    const setup_token_id = (kind === 'paypal')
      ? (paypalLastSetupTokenPaypal || localStorage.getItem('pp_last_setup_token_paypal') || '').trim()
      : (paypalLastSetupTokenCard || localStorage.getItem('pp_last_setup_token_card') || '').trim();

    if (!setup_token_id) throw new Error('No setup_token_id stored. Create one first.');

    const label = (kind === 'paypal')
      ? document.getElementById('paypal_pm_label_paypal').value.trim()
      : document.getElementById('paypal_pm_label_card').value.trim();

    const make_default = (kind === 'paypal')
      ? document.getElementById('paypal_pm_default_paypal').checked
      : document.getElementById('paypal_pm_default_card').checked;

    const resp = await paypalApi('/api/billing/payment-methods/paypal/exchange-token', {
      method:'POST',
      body: JSON.stringify({setup_token_id, label, make_default})
    });

    document.getElementById(msgId).innerHTML = 'Saved token <code>' + resp.payment_token_id + '</code>.';
    await paypalLoadPaymentMethods();
    showPaypalPane('list_methods');
    setTimeout(paypalRefreshAll, 600);
  } catch (e) {
    document.getElementById(msgId).innerText = 'Error: ' + e.message;
  }
}

async function paypalChargeOnce() {
  document.getElementById('paypal_charge_result').innerText = '';
  try {
    const amount = parseInt(document.getElementById('paypal_charge_amount').value.trim());
    if (!Number.isFinite(amount) || amount <= 0) throw new Error('Enter amount (cents)');

    const useDefault = document.getElementById('paypal_charge_use_default').value === '1';
    const token = useDefault ? null : (document.getElementById('paypal_charge_token').value.trim() || null);

    const payload = {amount_cents: amount, reason: 'one_time_charge'};
    if (token) payload.payment_token_id = token;

    const res = await paypalApi('/api/billing/charge-once', {method:'POST', body: JSON.stringify(payload)});
    const orderId = res.order_id || '';
    const approveUrl = res.approve_url || '';

    if (approveUrl) {
      document.getElementById('paypal_charge_result').innerHTML =
        'Order <code>' + orderId + '</code> created — opening approval...';
      window.open(approveUrl, '_blank');
    } else if (orderId) {
      document.getElementById('paypal_charge_result').innerHTML =
        'Order <code>' + orderId + '</code> created — capturing...';
      const cap = await paypalApi('/api/billing/paypal/capture-order', {method:'POST', body: JSON.stringify({order_id: orderId})});
      document.getElementById('paypal_charge_result').innerText = cap.ok ? 'Captured!' : 'Capture failed.';
      setTimeout(paypalRefreshAll, 800);
    } else {
      document.getElementById('paypal_charge_result').innerText = 'Created (no order_id returned?)';
    }
  } catch (e) {
    document.getElementById('paypal_charge_result').innerText = 'Error: ' + e.message;
  }
}

function paypalGetQueryParam(name) {
  const u = new URL(window.location.href);
  return u.searchParams.get(name);
}

async function paypalCaptureFromUrlToken(silent=false) {
  try {
    const orderId = paypalGetQueryParam('token');
    if (!orderId) {
      if (!silent) document.getElementById('paypal_charge_result').innerText = 'No ?token=... in URL.';
      return;
    }
    if (!silent) document.getElementById('paypal_charge_result').innerHTML = 'Capturing <code>' + orderId + '</code>...';
    const cap = await paypalApi('/api/billing/paypal/capture-order', {method:'POST', body: JSON.stringify({order_id: orderId})});
    if (!silent) document.getElementById('paypal_charge_result').innerText = cap.ok ? 'Captured!' : 'Capture failed.';
    const u = new URL(window.location.href);
    u.searchParams.delete('token');
    window.history.replaceState({}, document.title, u.toString());
    setTimeout(paypalRefreshAll, 800);
  } catch (e) {
    if (!silent) document.getElementById('paypal_charge_result').innerText = 'Capture error: ' + e.message;
  }
}

async function paypalStartSubscription() {
  document.getElementById('paypal_sub_result').innerText = '';
  try {
    const plan_id = document.getElementById('paypal_sub_plan').value.trim() || 'monthly';
    const paypal_plan_id = document.getElementById('paypal_sub_paypal_plan').value.trim() || null;

    const payload = {plan_id};
    if (paypal_plan_id) payload.paypal_plan_id = paypal_plan_id;

    const res = await paypalApi('/api/billing/subscribe-monthly', {method:'POST', body: JSON.stringify(payload)});
    const approveUrl = res.approve_url || '';
    const subId = res.subscription_id || '';

    document.getElementById('paypal_sub_result').innerHTML =
      'Subscription ' + (subId ? ('<code>' + subId + '</code>') : '') +
      (approveUrl ? (' — <a href="' + approveUrl + '" target="_blank" rel="noreferrer">approve</a>') : '');

    if (approveUrl) window.open(approveUrl, '_blank');
    setTimeout(paypalRefreshAll, 800);
  } catch (e) {
    document.getElementById('paypal_sub_result').innerText = 'Error: ' + e.message;
  }
}

async function paypalLoadLedger() {
  const wrap = document.getElementById('paypal_ledger');
  wrap.innerHTML = '';
  try {
    const limitTxt = document.getElementById('paypal_ledger_limit').value.trim();
    const limit = limitTxt ? parseInt(limitTxt) : 50;
    const res = await paypalApi('/api/billing/ledger?limit=' + encodeURIComponent(limit));
    const items = res.items || [];

    for (const it of items) {
      const div = document.createElement('div');
      div.className = 'item';

      let pill = '<span class="pill">' + (it.state || '') + '</span>';
      if (it.state === 'settled') pill = '<span class="pill ok">settled</span>';
      if (it.state === 'pending') pill = '<span class="pill warn">pending</span>';
      if (it.state === 'reversed') pill = '<span class="pill bad">reversed</span>';

      div.innerHTML = `
        <div class="row">
          ${pill}
          <div class="muted">${new Date((it.ts||0)*1000).toISOString()}</div>
          <div class="mono">${it.type}</div>
          <div class="mono">${it.reason || ''}</div>
          <div class="right mono">${it.amount_cents}</div>
        </div>
        <div class="muted mono w100">
          ${it.paypal_order_id ? ('order=' + it.paypal_order_id + ' ') : ''}
          ${it.paypal_capture_id ? ('cap=' + it.paypal_capture_id + ' ') : ''}
          ${it.paypal_payment_token_id ? ('token=' + it.paypal_payment_token_id + ' ') : ''}
          ${it.paypal_subscription_id ? ('sub=' + it.paypal_subscription_id + ' ') : ''}
          ${it.entry_id ? ('entry=' + it.entry_id) : ''}
        </div>
      `;
      wrap.appendChild(div);
    }

    if (items.length === 0) wrap.innerHTML = '<div class="muted">No ledger entries yet.</div>';
  } catch (e) {
    wrap.innerHTML = '<div class="muted">Error loading ledger: ' + e.message + '</div>';
  }
}
</script>
</body>
</html>
