<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Security Control Panel</title>
  <script src="https://js.stripe.com/v3/"></script>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>

<div class="topbar">
  <div>
    <div><b>Control Panel</b></div>
    <div class="muted" id="whoami">Not logged in</div>
  </div>
  <div class="toolbar">
    <button id="btnRefreshAll">Refresh</button>
    <button id="btnSetTokens">Set tokens</button>
    <button id="btnClearSession">Logout UI session</button>
    <button id="btnClearTokens">Clear tokens</button>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>API Key IP Allowlist</h3>
    <div class="muted">CIDR or IP. If empty → all IPs allowed.</div>
    <div class="muted">Selected key: <code class="mono" id="allowKeyId">none</code></div>
    <div class="row-inline" style="margin-top:8px;">
      <input id="allowAddVal" placeholder="1.2.3.4 or 1.2.3.0/24" style="margin-top:0; flex:1;" />
      <button id="allowAddBtn">Add</button>
    </div>
    <table id="allowTbl">
      <thead><tr><th>IP/CIDR</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h3>API Keys</h3>
    <div class="muted">Manage API keys and IP rules.</div>
    <div class="row-inline" style="margin-top:10px;">
      <button id="keysRefreshBtn">Refresh</button>
      <button id="keysCreateBtn">Create key</button>
    </div>
    <div id="keysList" class="list"></div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>TOTP Devices</h3>
    <div class="row-inline" style="margin-top:10px;">
      <button id="totpAddBtn">Add device</button>
      <button id="totpRefreshBtn">Refresh</button>
    </div>
    <div class="muted">Any one device can satisfy TOTP factor. Adding/removing requires a TOTP code.</div>
    <table id="totpTbl">
      <thead><tr><th>Label</th><th>Enabled</th><th>Last Used</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h3>SMS Devices</h3>
    <div class="muted">Up to 3 phone numbers. Login SMS codes are sent to all enabled numbers.</div>
    <div class="row-inline" style="margin-top:10px;">
      <button id="smsRefreshBtn">Refresh</button>
      <button id="smsAddBtn">Add phone</button>
    </div>
    <table id="smsTbl">
      <thead><tr><th>Phone</th><th>Label</th><th>Enabled</th><th>Last Used</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>Email Devices</h3>
    <div class="muted">Up to 5 emails. Login email codes are sent to all enabled emails.</div>
    <div class="row-inline" style="margin-top:10px;">
      <button id="emailRefreshBtn">Refresh</button>
      <button id="emailAddBtn">Add email</button>
    </div>
    <table id="emailTbl">
      <thead><tr><th>Email</th><th>Label</th><th>Enabled</th><th>Last Used</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h3>Web UI Sessions</h3>
    <div class="muted">Your active UI sessions (this browser will show as “current”).</div>
    <div class="row-inline" style="margin-top:10px;">
      <button id="sessRefreshBtn">Refresh</button>
      <button id="sessRevokeOthersBtn">Revoke all other sessions</button>
    </div>
    <div id="sessList" class="list"></div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>Alert Recipients</h3>
    <div class="section">
      <b>Email recipients</b>
      <div class="row-inline" style="margin-top:8px;">
        <input id="alertEmailInput" placeholder="security@example.com" />
        <button id="alertEmailAddBtn">Add</button>
      </div>
      <div id="alertEmailList" class="list"></div>
    </div>
    <div class="section">
      <b>SMS recipients</b>
      <div class="row-inline" style="margin-top:8px;">
        <input id="alertSmsInput" placeholder="+15551234567 or 5551234567" />
        <button id="alertSmsAddBtn">Add</button>
      </div>
      <div id="alertSmsList" class="list"></div>
    </div>
  </div>

  <div class="card">
    <h3>Alert Preferences</h3>
    <div class="section">
      <b>Email alert types</b>
      <div class="muted">Checked types will send email when those events occur.</div>
      <div id="alertTypeChecklist" class="list" style="margin-top:8px;"></div>
      <div class="row-inline" style="margin-top:10px;">
        <button id="alertTypesSaveBtn">Save</button>
      </div>
      <div id="alertTypesMsg" class="muted"></div>
    </div>
    <div class="section">
      <b>SMS alert types</b>
      <div class="muted">Checked types will send SMS when those events occur.</div>
      <div id="alertSmsTypeChecklist" class="list" style="margin-top:8px;"></div>
      <div class="row-inline" style="margin-top:10px;">
        <button id="alertSmsTypesSaveBtn">Save</button>
      </div>
      <div id="alertSmsTypesMsg" class="muted"></div>
    </div>
    <div class="section">
      <b>Toast alert types</b>
      <div class="muted">Checked types will show a toast notification on all active web sessions.</div>
      <div id="alertToastTypeChecklist" class="list" style="margin-top:8px;"></div>
      <div class="row-inline" style="margin-top:10px;">
        <button id="alertToastTypesSaveBtn">Save</button>
      </div>
      <div id="alertToastTypesMsg" class="muted"></div>
    </div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>Push Notifications</h3>
    <div class="muted">Register this browser for push alerts.</div>
    <div class="row-inline" style="margin-top:10px;">
      <button id="btnEnablePush">Enable push on this browser</button>
      <button id="btnPushTest">Send test push</button>
    </div>
    <div id="pushMsg" class="muted"></div>
    <div class="section">
      <b>Push alert types</b>
      <div id="alertPushTypeChecklist" class="list" style="margin-top:8px;"></div>
      <div class="row-inline" style="margin-top:10px;">
        <button id="alertPushTypesSaveBtn">Save</button>
      </div>
      <div id="alertPushTypesMsg" class="muted"></div>
    </div>
    <div class="section">
      <b>Registered push devices</b>
      <div id="pushDevicesList" class="list"></div>
    </div>
  </div>

  <div class="card">
    <h3>Recent Alerts</h3>
    <div class="muted">Latest alerts for this account.</div>
    <div id="alertsList" class="list"></div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>Billing (Stripe)</h3>
    <div class="muted">Manage payment methods, balances, and ledger entries.</div>
    <div class="row-inline" style="margin-top:10px;">
      <button id="billingRefreshBtn">Refresh billing</button>
      <span id="billingStatus" class="muted"></span>
    </div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3 style="margin:0 0 8px 0">Balance</h3>
    <div class="row">
      <div>
        <div class="muted">Due (settled)</div>
        <div class="mono" style="font-size:22px" id="due_settled">—</div>
      </div>
      <div style="width:24px"></div>
      <div>
        <div class="muted">Due (if pending settles)</div>
        <div class="mono" style="font-size:22px" id="due_all">—</div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <div class="muted">Owed pending:</div><div class="mono" id="owed_pending">—</div>
      <div class="muted">Owed settled:</div><div class="mono" id="owed_settled">—</div>
    </div>
    <div class="row">
      <div class="muted">Payments pending:</div><div class="mono" id="pay_pending">—</div>
      <div class="muted">Payments settled:</div><div class="mono" id="pay_settled">—</div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <button class="primary" id="paySettledBalanceBtn">Pay settled balance</button>
      <input id="pay_amount" placeholder="amount (optional, cents)" style="width:220px"/>
      <span id="pay_result" class="muted"></span>
    </div>

    <div class="row">
      <label class="muted">Autopay</label>
      <input type="checkbox" id="autopay"/>
      <span class="muted">Webhook-driven settlement; autopay scheduling is backend/worker responsibility.</span>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0">Payment methods</h3>

    <div class="row">
      <button id="paneAddCardBtn">Add card</button>
      <button id="paneAddBankBtn">Add checking (ACH)</button>
      <button id="paneVerifyBankBtn">Verify microdeposits</button>
      <button id="paneListMethodsBtn" class="primary">List</button>
    </div>

    <div class="hr"></div>

    <div id="pane_add_card" class="pane">
      <div class="muted">Add a credit/debit card (saved for future off-session payments).</div>
      <div style="margin-top:10px" id="card-element"></div>
      <div class="row" style="margin-top:10px">
        <button class="primary" id="addCardBtn">Save card</button>
        <span id="add_card_result" class="muted"></span>
      </div>
    </div>

    <div id="pane_add_bank" class="pane hidden">
      <div class="muted">
        Add a US checking account via ACH. Microdeposit verification may be required.
      </div>
      <div class="row" style="margin-top:10px">
        <input id="bank_name" placeholder="Name (for mandate)" style="width:260px"/>
        <input id="bank_email" placeholder="Email (optional)" style="width:260px"/>
      </div>
      <div class="row">
        <button class="primary" id="addBankAccountBtn">Start ACH setup</button>
        <span id="add_bank_result" class="muted"></span>
      </div>
      <div id="bank_next" class="muted" style="margin-top:10px"></div>
    </div>

    <div id="pane_verify_bank" class="pane hidden">
      <div class="muted">
        If the SetupIntent requires microdeposit verification, paste the SetupIntent ID below and verify by amounts or descriptor code.
      </div>

      <div class="row" style="margin-top:10px">
        <input id="verify_si" placeholder="setup_intent_id (e.g. seti_...)" style="width:420px"/>
        <button id="usePendingSetupIntentBtn">Use last pending from this browser</button>
      </div>

      <div class="row">
        <input id="amt1" placeholder="amount1 (cents)" style="width:180px"/>
        <input id="amt2" placeholder="amount2 (cents)" style="width:180px"/>
        <button class="primary" id="verifyByAmountsBtn">Verify by amounts</button>
      </div>

      <div class="row">
        <input id="desc" placeholder="descriptor code (optional)" style="width:300px"/>
        <button class="primary" id="verifyByDescriptorBtn">Verify by code</button>
      </div>

      <div class="row">
        <span id="verify_result" class="muted"></span>
      </div>
    </div>

    <div id="pane_list_methods" class="pane hidden">
      <div id="methods" class="list"></div>
    </div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3 style="margin:0 0 8px 0">Ledger</h3>
    <div class="row">
      <button id="loadLedgerBtn">Refresh ledger</button>
      <input id="ledger_limit" placeholder="limit (default 50)" style="width:200px"/>
      <span class="muted">Shows most recent first</span>
    </div>
    <div id="ledger" class="list" style="margin-top:10px"></div>
  </div>
</div>

<div class="err" id="globalErr" style="margin-top:12px;"></div>

<div id="toastContainer" class="toast-container"></div>

<script src="/static/main.js"></script>
</body>
</html>
