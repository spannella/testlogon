<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Billing</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:24px;max-width:1100px}
    h2{margin:0 0 12px 0}
    .muted{color:#666;font-size:13px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{border:1px solid #ddd;border-radius:10px;padding:16px;background:#fff}
    .row{display:flex;gap:10px;align-items:center;margin:8px 0;flex-wrap:wrap}
    .row > *{flex:0 0 auto}
    input,select{padding:8px 10px;border:1px solid #ccc;border-radius:8px}
    button{padding:8px 12px;border:1px solid #999;border-radius:8px;background:#f7f7f7;cursor:pointer}
    button.primary{background:#111;color:#fff;border-color:#111}
    button.danger{background:#fff5f5;border-color:#f0b4b4}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #ddd;font-size:12px}
    .pill.ok{border-color:#b8e0c2;background:#effaf2}
    .pill.warn{border-color:#f2d29b;background:#fff7e8}
    .pill.bad{border-color:#f0b4b4;background:#fff0f0}
    .hr{height:1px;background:#eee;margin:12px 0}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{border:1px solid #eee;border-radius:10px;padding:10px}
    .right{margin-left:auto}
    .w100{width:100%}
    .hidden{display:none}
    #card-element{padding:10px;border:1px solid #ccc;border-radius:8px;width:360px}
  </style>
</head>
<body>
  <h2>Billing</h2>
  <div class="muted">
    Uses the stored <code>access_token</code> and <code>session_id</code> from localStorage.
    <a href="/" style="margin-left:8px;">Open Control Panel</a>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="row">
      <span id="status" class="muted"></span>
      <button class="primary" onclick="refreshAll()">Refresh</button>
    </div>
  </div>

  <div class="grid" style="margin-top:16px">
    <div class="card">
      <h3 style="margin:0 0 8px 0">Balance</h3>
      <div class="row">
        <div>
          <div class="muted">Due (settled)</div>
          <div class="mono" style="font-size:22px" id="due_settled">—</div>
        </div>
        <div style="width:24px"></div>
        <div>
          <div class="muted">Due (if pending settles)</div>
          <div class="mono" style="font-size:22px" id="due_all">—</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="muted">Owed pending:</div><div class="mono" id="owed_pending">—</div>
        <div class="muted">Owed settled:</div><div class="mono" id="owed_settled">—</div>
      </div>
      <div class="row">
        <div class="muted">Payments pending:</div><div class="mono" id="pay_pending">—</div>
        <div class="muted">Payments settled:</div><div class="mono" id="pay_settled">—</div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button class="primary" onclick="paySettledBalance()">Pay settled balance</button>
        <input id="pay_amount" placeholder="amount (optional, cents)" style="width:220px"/>
        <span id="pay_result" class="muted"></span>
      </div>

      <div class="row">
        <label class="muted">Autopay</label>
        <input type="checkbox" id="autopay" onchange="setAutopay()"/>
        <span class="muted">Webhook-driven settlement; autopay scheduling is backend/worker responsibility.</span>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Payment methods</h3>

      <div class="row">
        <button onclick="showPane('add_card')">Add card</button>
        <button onclick="showPane('add_bank')">Add checking (ACH)</button>
        <button onclick="showPane('verify_bank')">Verify microdeposits</button>
        <button onclick="showPane('list_methods')" class="primary">List</button>
      </div>

      <div class="hr"></div>

      <div id="pane_add_card" class="pane">
        <div class="muted">Add a credit/debit card (saved for future off-session payments).</div>
        <div style="margin-top:10px" id="card-element"></div>
        <div class="row" style="margin-top:10px">
          <button class="primary" onclick="addCard()">Save card</button>
          <span id="add_card_result" class="muted"></span>
        </div>
      </div>

      <div id="pane_add_bank" class="pane hidden">
        <div class="muted">
          Add a US checking account via ACH. Microdeposit verification may be required.
        </div>
        <div class="row" style="margin-top:10px">
          <input id="bank_name" placeholder="Name (for mandate)" style="width:260px"/>
          <input id="bank_email" placeholder="Email (optional)" style="width:260px"/>
        </div>
        <div class="row">
          <button class="primary" onclick="addBankAccount()">Start ACH setup</button>
          <span id="add_bank_result" class="muted"></span>
        </div>
        <div id="bank_next" class="muted" style="margin-top:10px"></div>
      </div>

      <div id="pane_verify_bank" class="pane hidden">
        <div class="muted">
          If the SetupIntent requires microdeposit verification, paste the SetupIntent ID below and verify by amounts or descriptor code.
        </div>

        <div class="row" style="margin-top:10px">
          <input id="verify_si" placeholder="setup_intent_id (e.g. seti_...)" style="width:420px"/>
          <button onclick="usePendingSetupIntent()">Use last pending from this browser</button>
        </div>

        <div class="row">
          <input id="amt1" placeholder="amount1 (cents)" style="width:180px"/>
          <input id="amt2" placeholder="amount2 (cents)" style="width:180px"/>
          <button class="primary" onclick="verifyByAmounts()">Verify by amounts</button>
        </div>

        <div class="row">
          <input id="desc" placeholder="descriptor code (optional)" style="width:300px"/>
          <button class="primary" onclick="verifyByDescriptor()">Verify by code</button>
        </div>

        <div class="row">
          <span id="verify_result" class="muted"></span>
        </div>
      </div>

      <div id="pane_list_methods" class="pane hidden">
        <div id="methods" class="list"></div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px 0">Ledger</h3>
    <div class="row">
      <button onclick="loadLedger()">Refresh ledger</button>
      <input id="ledger_limit" placeholder="limit (default 50)" style="width:200px"/>
      <span class="muted">Shows most recent first</span>
    </div>
    <div id="ledger" class="list" style="margin-top:10px"></div>
  </div>

  <script src="/static/billing.js"></script>
</body>
</html>
